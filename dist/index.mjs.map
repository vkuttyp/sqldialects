{"version":3,"file":"index.mjs","names":["staticIndexes: number[]","DIALECTS_WITH_RET: Set<SQLDialect>","connectors: Record<ConnectorName, string>"],"sources":["../src/template.ts","../src/database.ts","../src/_connectors.ts"],"sourcesContent":["import type { Primitive } from \"./types.ts\";\n\nexport function sqlTemplate(\n  strings: TemplateStringsArray,\n  ...values: Primitive[]\n): [string, Primitive[]] {\n  if (!isTemplateStringsArray(strings) || !Array.isArray(values)) {\n    throw new Error(\"[sqldialects] invalid template invocation\");\n  }\n\n  const staticIndexes: number[] = [];\n\n  let result = strings[0] || \"\";\n  for (let i = 1; i < strings.length; i++) {\n    if (result.endsWith(\"{\") && strings[i]?.startsWith(\"}\")) {\n      result = result.slice(0, -1) + values[i - 1] + strings[i]!.slice(1);\n      staticIndexes.push(i - 1);\n      continue;\n    }\n    result += `?${strings[i] ?? \"\"}`;\n  }\n\n  const dynamicValues = values.filter((_, i) => !staticIndexes.includes(i));\n\n  return [result.trim(), dynamicValues];\n}\n\nfunction isTemplateStringsArray(\n  strings: unknown,\n): strings is TemplateStringsArray {\n  return (\n    Array.isArray(strings) && \"raw\" in strings && Array.isArray(strings.raw)\n  );\n}\n","import { sqlTemplate } from \"./template.js\";\nimport type { Connector, Database, SQLDialect } from \"./types.js\";\nimport type { Primitive } from \"./types.js\";\n\nconst SQL_SELECT_RE = /^select/i;\nconst SQL_RETURNING_RE = /[\\s]returning[\\s]/i;\nconst DIALECTS_WITH_RET: Set<SQLDialect> = new Set([\"postgresql\", \"sqlite\"]);\n\nconst DISPOSED_ERR =\n  \"This database instance has been disposed and cannot be used.\";\n\n/**\n * Creates and returns a database interface using the specified connector.\n * This interface allows you to execute raw SQL queries, prepare SQL statements,\n * and execute SQL queries with parameters using tagged template literals.\n *\n * @param {Connector} connector - The database connector used to execute and prepare SQL statements. See {@link Connector}.\n * @returns {Database} The database interface that allows SQL operations. See {@link Database}.\n */\nexport function createDatabase<TConnector extends Connector = Connector>(\n  connector: TConnector,\n): Database<TConnector> {\n  let _disposed = false;\n  const checkDisposed = () => {\n    if (_disposed) {\n      const err = new Error(DISPOSED_ERR);\n      if (typeof (Error as any).captureStackTrace === \"function\") {\n        (Error as any).captureStackTrace(err, checkDisposed);\n      }\n      throw err;\n    }\n  };\n\n  return <Database<TConnector>>{\n    get dialect() {\n      return connector.dialect;\n    },\n\n    get disposed() {\n      return _disposed;\n    },\n\n    getInstance() {\n      checkDisposed();\n      return connector.getInstance();\n    },\n\n    exec: (sql: string) => {\n      checkDisposed();\n      return Promise.resolve(connector.exec(sql));\n    },\n\n    prepare: (sql: string) => {\n      checkDisposed();\n      return connector.prepare(sql);\n    },\n\n    sql: async (strings: TemplateStringsArray, ...values: Primitive[]) => {\n      checkDisposed();\n      const [sql, params] = sqlTemplate(strings, ...values);\n      if (\n        SQL_SELECT_RE.test(sql) /* select */ ||\n        // prettier-ignore\n        (DIALECTS_WITH_RET.has(connector.dialect) && SQL_RETURNING_RE.test(sql)) /* returning */\n      ) {\n        const rows = await connector.prepare(sql).all(...params);\n        return {\n          rows,\n          success: true,\n        };\n      } else {\n        const res = await connector.prepare(sql).run(...params);\n        return res;\n      }\n    },\n\n    dispose: () => {\n      if (_disposed) {\n        return Promise.resolve();\n      }\n      _disposed = true;\n      try {\n        return Promise.resolve(connector.dispose?.());\n      } catch (error) {\n        return Promise.reject(error);\n      }\n    },\n\n    [Symbol.asyncDispose]() {\n      return this.dispose();\n    },\n  };\n}\n","// Auto-generated using scripts/gen-connectors.\n// Do not manually edit!\nimport type { ConnectorOptions as BetterSQLite3Options } from \"sqldialects/connectors/better-sqlite3\";\nimport type { ConnectorOptions as BunSQLiteOptions } from \"sqldialects/connectors/bun-sqlite\";\nimport type { ConnectorOptions as CloudflareD1Options } from \"sqldialects/connectors/cloudflare-d1\";\nimport type { ConnectorOptions as CloudflareHyperdriveMySQLOptions } from \"sqldialects/connectors/cloudflare-hyperdrive-mysql\";\nimport type { ConnectorOptions as CloudflareHyperdrivePostgreSQLOptions } from \"sqldialects/connectors/cloudflare-hyperdrive-postgresql\";\nimport type { ConnectorOptions as LibSQLCoreOptions } from \"sqldialects/connectors/libsql/core\";\nimport type { ConnectorOptions as LibSQLHttpOptions } from \"sqldialects/connectors/libsql/http\";\nimport type { ConnectorOptions as LibSQLNodeOptions } from \"sqldialects/connectors/libsql/node\";\nimport type { ConnectorOptions as LibSQLWebOptions } from \"sqldialects/connectors/libsql/web\";\nimport type { ConnectorOptions as MSSQLOptions } from \"sqldialects/connectors/mssql\";\nimport type { ConnectorOptions as MySQL2Options } from \"sqldialects/connectors/mysql2\";\nimport type { ConnectorOptions as NodeSQLiteOptions } from \"sqldialects/connectors/node-sqlite\";\nimport type { ConnectorOptions as PgliteOptions } from \"sqldialects/connectors/pglite\";\nimport type { ConnectorOptions as PlanetscaleOptions } from \"sqldialects/connectors/planetscale\";\nimport type { ConnectorOptions as PostgreSQLOptions } from \"sqldialects/connectors/postgresql\";\nimport type { ConnectorOptions as SQLite3Options } from \"sqldialects/connectors/sqlite3\";\n\nexport type ConnectorName = \"better-sqlite3\" | \"bun-sqlite\" | \"bun\" | \"cloudflare-d1\" | \"cloudflare-hyperdrive-mysql\" | \"cloudflare-hyperdrive-postgresql\" | \"libsql-core\" | \"libsql-http\" | \"libsql-node\" | \"libsql\" | \"libsql-web\" | \"mssql\" | \"mysql2\" | \"node-sqlite\" | \"sqlite\" | \"pglite\" | \"planetscale\" | \"postgresql\" | \"sqlite3\";\n\nexport type ConnectorOptions = {\n  \"better-sqlite3\": BetterSQLite3Options;\n  \"bun-sqlite\": BunSQLiteOptions;\n  /** alias of bun-sqlite */\n  \"bun\": BunSQLiteOptions;\n  \"cloudflare-d1\": CloudflareD1Options;\n  \"cloudflare-hyperdrive-mysql\": CloudflareHyperdriveMySQLOptions;\n  \"cloudflare-hyperdrive-postgresql\": CloudflareHyperdrivePostgreSQLOptions;\n  \"libsql-core\": LibSQLCoreOptions;\n  \"libsql-http\": LibSQLHttpOptions;\n  \"libsql-node\": LibSQLNodeOptions;\n  /** alias of libsql-node */\n  \"libsql\": LibSQLNodeOptions;\n  \"libsql-web\": LibSQLWebOptions;\n  \"mssql\": MSSQLOptions;\n  \"mysql2\": MySQL2Options;\n  \"node-sqlite\": NodeSQLiteOptions;\n  /** alias of node-sqlite */\n  \"sqlite\": NodeSQLiteOptions;\n  \"pglite\": PgliteOptions;\n  \"planetscale\": PlanetscaleOptions;\n  \"postgresql\": PostgreSQLOptions;\n  \"sqlite3\": SQLite3Options;\n};\n\nexport const connectors: Record<ConnectorName, string> = Object.freeze({\n  \"better-sqlite3\": \"sqldialects/connectors/better-sqlite3\",\n  \"bun-sqlite\": \"sqldialects/connectors/bun-sqlite\",\n  /** alias of bun-sqlite */\n  \"bun\": \"sqldialects/connectors/bun-sqlite\",\n  \"cloudflare-d1\": \"sqldialects/connectors/cloudflare-d1\",\n  \"cloudflare-hyperdrive-mysql\": \"sqldialects/connectors/cloudflare-hyperdrive-mysql\",\n  \"cloudflare-hyperdrive-postgresql\": \"sqldialects/connectors/cloudflare-hyperdrive-postgresql\",\n  \"libsql-core\": \"sqldialects/connectors/libsql/core\",\n  \"libsql-http\": \"sqldialects/connectors/libsql/http\",\n  \"libsql-node\": \"sqldialects/connectors/libsql/node\",\n  /** alias of libsql-node */\n  \"libsql\": \"sqldialects/connectors/libsql/node\",\n  \"libsql-web\": \"sqldialects/connectors/libsql/web\",\n  \"mssql\": \"sqldialects/connectors/mssql\",\n  \"mysql2\": \"sqldialects/connectors/mysql2\",\n  \"node-sqlite\": \"sqldialects/connectors/node-sqlite\",\n  /** alias of node-sqlite */\n  \"sqlite\": \"sqldialects/connectors/node-sqlite\",\n  \"pglite\": \"sqldialects/connectors/pglite\",\n  \"planetscale\": \"sqldialects/connectors/planetscale\",\n  \"postgresql\": \"sqldialects/connectors/postgresql\",\n  \"sqlite3\": \"sqldialects/connectors/sqlite3\",\n} as const);\n"],"mappings":";AAEA,SAAgB,YACd,SACA,GAAG,QACoB;AACvB,KAAI,CAAC,uBAAuB,QAAQ,IAAI,CAAC,MAAM,QAAQ,OAAO,CAC5D,OAAM,IAAI,MAAM,4CAA4C;CAG9D,MAAMA,gBAA0B,EAAE;CAElC,IAAI,SAAS,QAAQ,MAAM;AAC3B,MAAK,IAAI,IAAI,GAAG,IAAI,QAAQ,QAAQ,KAAK;AACvC,MAAI,OAAO,SAAS,IAAI,IAAI,QAAQ,IAAI,WAAW,IAAI,EAAE;AACvD,YAAS,OAAO,MAAM,GAAG,GAAG,GAAG,OAAO,IAAI,KAAK,QAAQ,GAAI,MAAM,EAAE;AACnE,iBAAc,KAAK,IAAI,EAAE;AACzB;;AAEF,YAAU,IAAI,QAAQ,MAAM;;CAG9B,MAAM,gBAAgB,OAAO,QAAQ,GAAG,MAAM,CAAC,cAAc,SAAS,EAAE,CAAC;AAEzE,QAAO,CAAC,OAAO,MAAM,EAAE,cAAc;;AAGvC,SAAS,uBACP,SACiC;AACjC,QACE,MAAM,QAAQ,QAAQ,IAAI,SAAS,WAAW,MAAM,QAAQ,QAAQ,IAAI;;;;;AC3B5E,MAAM,gBAAgB;AACtB,MAAM,mBAAmB;AACzB,MAAMC,oBAAqC,IAAI,IAAI,CAAC,cAAc,SAAS,CAAC;AAE5E,MAAM,eACJ;;;;;;;;;AAUF,SAAgB,eACd,WACsB;CACtB,IAAI,YAAY;CAChB,MAAM,sBAAsB;AAC1B,MAAI,WAAW;GACb,MAAM,MAAM,IAAI,MAAM,aAAa;AACnC,OAAI,OAAQ,MAAc,sBAAsB,WAC9C,CAAC,MAAc,kBAAkB,KAAK,cAAc;AAEtD,SAAM;;;AAIV,QAA6B;EAC3B,IAAI,UAAU;AACZ,UAAO,UAAU;;EAGnB,IAAI,WAAW;AACb,UAAO;;EAGT,cAAc;AACZ,kBAAe;AACf,UAAO,UAAU,aAAa;;EAGhC,OAAO,QAAgB;AACrB,kBAAe;AACf,UAAO,QAAQ,QAAQ,UAAU,KAAK,IAAI,CAAC;;EAG7C,UAAU,QAAgB;AACxB,kBAAe;AACf,UAAO,UAAU,QAAQ,IAAI;;EAG/B,KAAK,OAAO,SAA+B,GAAG,WAAwB;AACpE,kBAAe;GACf,MAAM,CAAC,KAAK,UAAU,YAAY,SAAS,GAAG,OAAO;AACrD,OACE,cAAc,KAAK,IAAI,IAEtB,kBAAkB,IAAI,UAAU,QAAQ,IAAI,iBAAiB,KAAK,IAAI,CAGvE,QAAO;IACL,MAFW,MAAM,UAAU,QAAQ,IAAI,CAAC,IAAI,GAAG,OAAO;IAGtD,SAAS;IACV;OAGD,QADY,MAAM,UAAU,QAAQ,IAAI,CAAC,IAAI,GAAG,OAAO;;EAK3D,eAAe;AACb,OAAI,UACF,QAAO,QAAQ,SAAS;AAE1B,eAAY;AACZ,OAAI;AACF,WAAO,QAAQ,QAAQ,UAAU,WAAW,CAAC;YACtC,OAAO;AACd,WAAO,QAAQ,OAAO,MAAM;;;EAIhC,CAAC,OAAO,gBAAgB;AACtB,UAAO,KAAK,SAAS;;EAExB;;;;;AC7CH,MAAaC,aAA4C,OAAO,OAAO;CACrE,kBAAkB;CAClB,cAAc;CAEd,OAAO;CACP,iBAAiB;CACjB,+BAA+B;CAC/B,oCAAoC;CACpC,eAAe;CACf,eAAe;CACf,eAAe;CAEf,UAAU;CACV,cAAc;CACd,SAAS;CACT,UAAU;CACV,eAAe;CAEf,UAAU;CACV,UAAU;CACV,eAAe;CACf,cAAc;CACd,WAAW;CACZ,CAAU"}